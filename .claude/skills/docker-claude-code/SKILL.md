---
name: docker-claude-code
description: Use when setting up Docker containerized development environment with Claude Code CLI. Triggers: user requests Docker development environment, needs containerized Claude Code setup, mentions persistent volumes, configures multiple users (root/non-root), requires latest Claude Code CLI with statusline plugin.
---

# Docker Claude Code - Containerized Development Environment

## Overview

Containerized development environment for Claude Code CLI with automatic initialization, configuration persistence, and multi-user support.

**Core principle**: Single container with unified workspace persistence, complete isolation from host, ready-to-use Claude Code CLI.

**When to use**:
- User explicitly requests Docker container for Claude Code development
- User requires persistent configuration across container restarts
- User needs both root and non-root user access
- User wants latest Claude Code CLI with statusline plugin

**Critical**: This skill enforces **strict acceptance criteria** - no shortcuts, no rationalizations, no "good enough" compromises.

---

## Acceptance Criteria (MANDATORY)

**CRITICAL**: All criteria below MUST be satisfied exactly as stated. No partial compliance, no rationalizations allowed.

### ✅ Criterion 1: Directory Structure

**Required directory structure:**
```
project-root/
└── .claude/
    └── skills/
            └── docker-claude-code/
                ├── init-docker-project.sh  # Project initialization script
                ├── backup-project.sh     # Backup script
                ├── diagnose-docker.sh   # Diagnostics script
                ├── test-docker.sh        # Acceptance tests
                ├── validate-config.sh  # Configuration validator
                └── claude-code-statusline-plugin/  # Statusline plugin
                    ├── .claude-plugin/
                    │   └── plugin.json
                    ├── install.sh
                    └── statusline/
                        └── show-prompt.py
```

**Verification:**
```bash
# From project root
# 验证项目已通过 init-docker-project.sh 初始化
test -f .claude/skills/docker-claude-code/scripts/init-docker-project.sh && echo "PASS" || echo "FAIL"

# 验证必要的脚本文件存在
test -f .claude/skills/docker-claude-code/scripts/backup-project.sh && echo "PASS" || echo "FAIL"
test -f .claude/skills/docker-claude-code/scripts/diagnose-docker.sh && echo "PASS" || echo "FAIL"
test -f .claude/skills/docker-claude-code/scripts/test-docker.sh && echo "PASS" || echo "FAIL"

# 验证插件目录存在
test -d .claude/skills/docker-claude-code/claude-code-statusline-plugin && echo "PASS" || echo "FAIL"

# 验证配置文件已生成(在项目根目录)
test -f .env && echo "PASS" || echo "FAIL"
test -f docker-compose.yml && echo "PASS" || echo "FAIL"
test -f Dockerfile && echo "PASS" || echo "FAIL"
```

**Expected output:**
```
PASS
PASS
PASS
PASS
PASS
PASS
PASS
PASS
PASS
```

**No exceptions:**
- ❌ DO NOT manually modify container-generated files (使用 init 脚本进行修改)
- ❌ DO NOT skip settings.json registration

### ✅ Criterion 2: Persistent Initialized Container

**Required:**
- Container name: `docker-claude-code-app`
- Three persistent volumes mounted:
  - Project workspace: `${WORKSPACE_PATH:-./workspace}:/workspace`
  - Claude configuration: `${CLAUDE_CONFIG_PATH:-./dev-home/config}:/home/claude/.config/claude`
  - Claude user data: `${CLAUDE_HOME_PATH:-./dev-home/claude}:/home/claude`
- Container can start/stop/restart without losing data
- Working directory in container: `/workspace/project`
- Environment variables configured in `.env` file:
  ```bash
  # .env file content (generated by init-docker-project.sh)
  ANTHROPIC_API_KEY=dummy  # Uses host's API key
  ANTHROPIC_BASE_URL=http://host.docker.internal:15721  # CC Switch proxy port
  # Optional paths (defaults shown)
  # WORKSPACE_PATH=./workspace
  # CLAUDE_CONFIG_PATH=./dev-home/config
  # CLAUDE_HOME_PATH=./dev-home/claude
  ```

**Note**: Reference `.env.example` template in skill directory for all available configuration options and platform-specific notes.

**Verification:**
```bash
# From project root (after init-docker-project.sh)
docker-compose up -d
docker-compose exec app sh -c "echo 'container-access-ok'" && echo "PASS" || echo "FAIL"
docker-compose down
```

**No exceptions:**
- ❌ DO NOT skip workspace directory creation
- ❌ DO NOT omit config persistence volumes
- ❌ DO NOT use non-persistent containers

### ✅ Criterion 3: Latest Claude Code CLI

**Required:**
- Claude Code CLI installed in container
- Latest version verified with `claude doctor`
- Automatic update detection
- No manual intervention needed

**Verification:**
```bash
# From project root (after init-docker-project.sh)
docker-compose up -d
docker-compose exec app sh -c "claude --version" && echo "PASS" || echo "FAIL"
docker-compose exec app sh -c "claude doctor | grep -i version" && echo "PASS" || echo "FAIL"
docker-compose down
```

**No exceptions:**
- ❌ DO NOT use older CLI versions
- ❌ DO NOT skip version verification
- ❌ DO NOT claim "latest" without `claude doctor` confirmation

### ✅ Criterion 4: Statusline Plugin Installed

**Required:**
- Plugin installation script exists in skill directory
- Plugin automatically registered in `~/.claude/settings.json`
- Status bar displays: `[最新指令:{summary}]`
- Installation documented and verifiable

**Verification:**
```bash
# From project root (after init-docker-project.sh)
docker-compose up -d
docker-compose exec app sh -c 'python3 -c "import json; settings=json.load(open(\"~/.claude/settings.json\")); print(\"Plugin registered:\" if \"statusLine\" in settings else \"NOT REGISTERED\")"'
```

**Expected output:** `Plugin registered:`

**No exceptions:**
- ❌ DO NOT claim plugin is installed without verification
- ❌ DO NOT skip settings.json registration
- ❌ DO NOT use different status line format

### ✅ Criterion 5: Multi-User Access

**Required:**
- Non-root user access: `docker-compose exec app sh`
- Root user access: `docker-compose exec -u root app sh`
- sudo NOPASSWD:ALL configured for non-root user
- Both user types can perform their required operations

**Verification:**
```bash
# From project root (after init-docker-project.sh)
docker-compose up -d
# Non-root (default claude user)
docker-compose exec app sh -c "whoami" && echo "PASS" || echo "FAIL"
# Root
docker-compose exec -u root app sh -c "whoami | grep -q root" && echo "PASS" || echo "FAIL"
docker-compose down
```

**No exceptions:**
- ❌ DO NOT use different commands
- ❌ DO NOT omit sudo NOPASSWD:ALL configuration
- ❌ DO NOT claim multi-user support without verification

### ✅ Criterion 6: Test Validation Passes

**Required:**
- ALL above criteria verified with automated tests
- Tests pass with exit code 0
- No ERROR or CRITICAL log messages
- Manual verification matches automated results

**Verification:**
```bash
# Run all tests
bash .claude/skills/docker-claude-code/scripts/test-docker.sh
echo "Exit code: $?"
```

**Expected output:** Exit code 0, all tests PASS

**No exceptions:**
- ❌ DO NOT accept "good enough" test results
- ❌ DO NOT ignore failing tests
- ❌ DO NOT proceed until all tests pass

## Red Flags - STOP and Fix








- Non-root user cannot access container
- Any test fails (exit code ≠ 0)

**No rationalizations accepted:**
- "Directory names don't matter" → Criterion 1 requires exact structure
- "Can create later" → Must exist at initialization
- "Good enough" → Exact compliance required (Criterion 6)

**If you see ANY red flag, STOP and fix before proceeding.**

---

## Quick Start (TDD Workflow)

### Phase 1: Initialize (RED Phase)

**MANDATORY**: Start with test-driven development, NOT implementation.

1. **Create tests FIRST** (RED phase)
   ```bash
   bash .claude/skills/docker-claude-code/scripts/test-docker.sh
   # Tests MUST fail before implementation
   ```

2. **Initialize project**
   ```bash
   bash .claude/skills/docker-claude-code/scripts/init-docker-project.sh
   # Choose scenario: 1) New Project
   ```

3. **Validate configuration**
   ```bash
   bash .claude/skills/docker-claude-code/scripts/validate-config.sh
   # Exit code 0 = all checks PASS
   ```

### Phase 2: Deploy (GREEN Phase)

1. **Start container**
   ```bash
   # From project root (after init-docker-project.sh)
   docker-compose up -d
   ```

2. **Verify Claude CLI**
   ```bash
   docker-compose exec app sh -c "claude --version"
   docker-compose exec app sh -c "claude doctor"
   # Must show latest version
   ```

3. **Verify statusline plugin**
   ```bash
   docker-compose exec app sh -c 'python3 -c "import json; print(json.load(open(\"~/.claude/settings.json\")).get(\"statusLine\"))"'
   # Must show plugin config object
   ```

### Phase 3: Use (IMPROVE Phase)

**Non-root user (DEFAULT, RECOMMENDED):**
```bash
docker-compose exec app sh
```
- User: claude (UID 1001)
- Working directory: `/workspace/project` (项目代码挂载点)
- Has sudo NOPASSWD:ALL for privileged operations

**Root user (EMERGENCY ONLY):**
```bash
docker-compose exec -u root app sh
```
- User: root
- Use ONLY when non-root user cannot perform required operation

**IMPORTANT**: Prefer non-root user. Root user breaks container isolation principle.

### Phase 4: Test (VALIDATE Phase)

**MANDATORY**: Verify before use.

```bash
# Run all tests - must exit with code 0
bash .claude/skills/docker-claude-code/scripts/test-docker.sh
echo "Exit code: $?"  # Must be 0
```

**TDD Principle**: Tests first, implement minimally, verify all pass.

---

## Common Mistakes

| Mistake | Violates | Fix |
|---------|----------|-----|
| Manual Dockerfile creation without init script | Criterion 1 | Always use `init-docker-project.sh` for initialization |
| Skipping claude doctor verification | Criterion 3 | Always run `claude doctor` before claiming "latest" |
| Assuming plugin installed without verification | Criterion 4 | Verify in settings.json |
| Using root user by default | Isolation principle | Use non-root (claude) user |
| Ignoring test failures | Criterion 6 | Fix failing tests before proceeding |
| "Good enough" rationalizations | Skill principles | Exact compliance required |

---

## Troubleshooting

**MANDATORY**: Use diagnostic script before manual investigation.

```bash
# From project root (after init-docker-project.sh)
bash .claude/skills/docker-claude-code/scripts/diagnose-docker.sh
```

### Common Issues

**1. Container won't start**
- Check Dockerfile syntax: `docker-compose build`
- Check port conflicts: `docker ps` to see running containers
- Check volume mount paths in docker-compose.yml

**2. Claude CLI can't connect**
- Verify ANTHROPIC_BASE_URL matches CC Switch port (default 15721)
- Test from container: `docker-compose exec app sh -c "curl -v $ANTHROPIC_BASE_URL"`
- Check CC Switch is running on host

**3. Permission denied errors**
- Verify sudo NOPASSWD:ALL in Dockerfile
- Rebuild image: `docker-compose build --no-cache`
- Restart container: `docker-compose up -d`

**4. Config not persisting**
- Verify volume mounts in docker-compose.yml
- Check workspace/ directory exists
- Verify dev-home/ directories exist

**If diagnostic doesn't resolve issue:**
- Read diagnostic output carefully
- Follow specific fix recommendations
- Re-run diagnostic to verify fix
- DO NOT skip diagnostic steps

---

## Architecture Pattern

**Isolation Mode** (NOT sync mode):

**Key differences:**
- **File location**: Container-only (not synced with host)
- **Permissions**: No UID/GID conflicts between host and container
- **Environment isolation**: Strong separation from host system
- **Acceptance criteria**: Compliant with "files only in container" requirement

**Why isolation mode?**
1. Avoids host-container UID/GID conflicts
2. Non-root container user has full autonomy
3. Clean environment on every start
4. Complies with "files only in container" acceptance criterion

**Backup strategy:**
- **Configuration backup**: Copy dev-home/ directory
- **Project backup**: Use `docker cp` to export from container
- **Automated backup**: Use backup-project.sh script

---

## Scripts Reference

**All scripts located in**: `.claude/skills/docker-claude-code/scripts/`

| Script | Purpose | Usage |
|--------|---------|-------|
| **init-docker-project.sh** | Initialize project (new/migrate/backup) | `bash .../init-docker-project.sh` |
| **validate-config.sh** | Validate configuration files and settings | `bash .../validate-config.sh` |
| **diagnose-docker.sh** | Diagnose issues with decision tree | `bash .../diagnose-docker.sh` |
| **test-docker.sh** | Run all acceptance tests | `bash .../test-docker.sh` |
| **backup-project.sh** | Backup container files to host | `bash .../backup-project.sh` |

### Statusline Plugin

**Location**: `.claude/skills/docker-claude-code/claude-code-statusline-plugin/`

**Installation**: Automatic via init-docker-project.sh script

**Components:**
- `statusline/show-prompt.py` - Main plugin script
- `install.sh` - Installation script (Linux/macOS)
- `install.ps1` - Installation script (Windows)
- `.claude-plugin/plugin.json` - Plugin metadata

**Verification**: Plugin must be registered in `~/.claude/settings.json` (see Criterion 4)
